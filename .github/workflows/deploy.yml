name: Deploy to Kubernetes (Local)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Verify Kubernetes access
      - name: Verify cluster access
        run: |
          kubectl version --client
          kubectl config current-context
          kubectl get nodes

      # 3. Deploy PostgreSQL (ConfigMap, Secret, PVC, Deployment, Service)
      - name: Deploy PostgreSQL
        run: |
          kubectl apply -f K8s/postgres/
          kubectl rollout status deployment/postgres

      # 4. Deploy Backend
      - name: Deploy Backend
        run: |
          kubectl apply -f K8s/backend/
          kubectl rollout status deployment/backend

      # 5. Deploy Frontend
      - name: Deploy Frontend
        run: |
          kubectl apply -f K8s/frontend/
          kubectl rollout status deployment/frontend

      # 6. Apply Ingress (last)
      - name: Apply Ingress
        run: |
          kubectl apply -f K8s/ingress/ingress.yml

      # 7. Post-deploy verification
      - name: Verify resources
        run: |
          kubectl get pods
          kubectl get svc
          kubectl get ingress
